<div class="row" id='scoresheet'>
	<h2 class='col-sm-12'><span tkey="scoresheet">Scoresheet</span><small>Look at shares for each block height</small></h2>
	<div class='col-sm-1'>
		<div class="box box-widget widget-user-2">
	        <!-- Add the bg color to the header using any of the bg-* classes -->
	        <div class="widget-user-header bg-purple">
	          <!-- /.widget-user-image -->
	          <h3 class="widget-user-username">Block Height</h3>
	        </div>
	        <div class="box-footer no-padding">
                <table class="table table-striped text-center">
                    
                    <tbody id='height_lists'>
                        
                    </tbody>
                </table>
	        </div>
	      </div>		
	</div>
	<div class='col-sm-10'>
		<div class="card"  id="currentScores">
            <div class="table-responsive">
                <table class="table table-striped">
                    <thead>
                    <tr>
                        <th class="text-center">#</th>
                        <th class="text-center"><span tkey="miner">Miner</span></th>
                        <th class="text-center"><span tkey="hashRate">Hash Rate</span></th>
                        <th class="text-center"><span tkey="totalHashes">Total Hashes Submitted</span></th>
                        <th class="text-center"><span tkey="roundShare">Round Shares (%)</span></th>
                    </tr>
                    </thead>
                    <tbody id="current_rows"></tbody>
                </table>
            </div>
        </div>
        <div class="card" id="scoresheetCard" >
		    <div class="table-responsive">
    		        <table class="table table-striped">
    		            <thead>
    		            <tr>
                            <th class="text-center"><span>#</span></th>
    		                <th class="text-center"><span tkey="miner">Miner</span></th>
    		                <th class="text-center"><span tkey="hashes">Unlock Reward</span></th>
    		                <th class="text-center"><span tkey="donations">Credited</span></th>
    		                <th class="text-center"><span tkey="donationLevel">Total Hashes Submitted</span></th>
    		                <th class="text-center"><span tkey="totalBlocks">Round Shares (%)</span></th>
    		            </tr>
                        <tr>
                            <th colspan="6" class="text-center" id='tableSummary' style="background-color: #7747c7;color:#FFF"></th>
                        </tr>
    		            </thead>
    		            <tbody id="scoresheet_rows"></tbody>
    		        </table>
    		    </div>
    		</div>
        </div>
	</div>
</div>
<!-- Javascript -->
<script>


var varTop10 = false;
var xhrGetTOP;
// Update current page
currentPage = {
    destroy: function(){
    	
    	if(xhrGetTOP){
    		xhrGetTOP.destroy();
    	}
    	clearTimeout(varTop10);
    },
    update: function(){
        var heights  = [];
        for(var i = 0,il = lastStats.pool.blocks.length;i<il;i++){
            heights.push(lastStats.pool.blocks[i+1]);
        }
        renderHeights(heights);
    }
};



function renderCells(p,data){
    console.log(data);
    return  '<tr><td class="col1 text-center" >' + p + '</td>' +
            '<td class="col2 text-center" >' + data.miner + '</td>' +
            '<td class="col4 text-center">' + getReadableCoins(data.bonus,5,true) + '</td>'+
            '<td class="col5 text-center">' + getReadableCoins(data.earn,5,true) + '</td>'+
            '<td class="col3 text-center">' + formatDifficulty(data.score) + '</td>'+
            '<td class="col6 text-center">' + parseFloat(data.percent * 100).toFixed(5) + '%</td></tr>';
}

// Update top10 miners report
function renderHeights(heights){
	var _d =[];
    var hL = heights.length;

    for(var i =0;i<hL;i++){
    	var height = heights[i];
    	if(height === 'Current'){
    		continue;
    	}
 		_d[height]="<tr><td><a href='#' class='hyperlink height-select' data-id='"+height+"'>"+height+"</a></td></tr>";
	}
	_d[_d.length-1]="<tr><td><a href='#' class='hyperlink height-select' data-id='Current'>Current</a></td></tr>";

	$('#height_lists').html(_d.reverse().join(''));   
    $('.height-select').on('click',function(e){
        e.preventDefault();

        var id = $(this).data('id');
        if(id !== currentSelectedHeight){
            currentSelectedHeight = id;
            updateScoresheet();
        }
    });
}
var currentSelectedHeight;

var renderCurrentRoundMiners = function(data){
    var tr = $("#current_rows");
    var html = "";
    var row =
        '<tr style="text-align:center;"><td class="col1 font12">%ID%</td>' +
        '<td class="col2 font12">%MINER%</td>' +
        '<td class="col3 font12">%HASHRATE%</td>' +
        '<td class="col4 font12">%HASHES%</td>' +
        '<td class="col5 font12">%PERCENT%</td></tr>';
        
    var totalPoolScore = lastStats.pool.roundHashes;
    for(var i in data){

        var percent = (data[i].roundHashes * 100/ totalPoolScore).toFixed(3);
        html += row
        .replace("%ID%",parseInt(i)+1)
        .replace("%MINER%",data[i].miner)
        .replace("%HASHRATE%",data[i].hashrate)
        .replace("%HASHES%",formatDifficulty(data[i].roundHashes))
        .replace("%PERCENT%",percent);
    }
    
    tr.html(html);
};

var renderLockedBlocks = function(data){
    var tr = $("#current_rows");
    var html = "";
    var row =
        '<tr style="text-align:center;"><td class="col1 font12">%ID%</td>' +
        '<td class="col2 font12">%MINER%</td>' +
        '<td class="col3 font12">%HASHRATE%</td>' +
        '<td class="col4 font12">%HASHES%</td>' +
        '<td class="col5 font12">%PERCENT%</td></tr>';
        
    var miners = Object.keys(data);
    var totalHashes = 0;
    miners.map(function(miner){
        totalHashes+= parseInt(data[miner]);
    });
    for(var i in miners){
        var miner = miners[i];
        var score = data[miner];
        var scorePercent = (score / totalHashes) *100;
        
        html += row
        .replace("%ID%",parseInt(i)+1)
        .replace("%MINER%",miner)
        .replace("%HASHRATE%","-")
        .replace("%HASHES%",formatDifficulty(score))
        .replace("%PERCENT%",scorePercent.toFixed(5));
    }
    
    tr.html(html);
};

function sortByPercentage(data, limit) {
    limit = limit || 10;
    data.sort(function(a,b){
        var v1 = a.blocksFound ? parseInt(a.blocksFound) : 0;
        var v2 = b.blocksFound ? parseInt(b.blocksFound) : 0;
        if (v1 > v2) return -1;
        if (v1 < v2) return 1;
        return 0;   
    });

    return data.slice(0,limit);
}

function updateScoresheet() {
    var xhrGetTOP = $.ajax({
        url: api + '/pool_scoresheet',
        dataType: 'json',
        data:{
        	height:currentSelectedHeight
        },
        cache: 'false',
        success: function(data){
            if (!data) {
            	return;
            }
            if(data.height.toLowerCase() === 'current' ){
                renderCurrentRoundMiners(data.data);
                $('#currentScores').show();
                $('#scoresheetCard').hide();
                return;
            }

            var html = "";
            var miners = data.data;

            if(!miners.hasOwnProperty('Info')){
                renderLockedBlocks(miners);
                $('#currentScores').show();
                $('#scoresheetCard').hide();
                return;
            }
            var i = 0;
            for(var miner in miners){
                var data = miners[miner];

                if(miner == "Info"){
                    var block = data.split(":");
                    console.log(block);
                    var sum = "<b>HEIGHT:</b> %HEIGHT% <b>TIME:</b> %TIME% <b>TOTAL HASHES:</b> %TOTAL_HASHES% <b>DIFFICULTY:</b> %DIFFICULTY% <b>REWARD:</b> %REWARD% <b>UNLOCKER:</b> %UNLOCKER%";
                    sum = sum.replace("%HEIGHT%",currentSelectedHeight);
                    sum = sum.replace("%TIME%",formatDate(block[1]));
                    sum = sum.replace("%TOTAL_HASHES%",formatDifficulty(block[3]));
                    sum = sum.replace("%DIFFICULTY%",formatDifficulty(block[2]));
                    sum = sum.replace("%REWARD%",getReadableCoins(block[5]));
                    sum = sum.replace("%UNLOCKER%",block[6]);
                    $('#tableSummary').html(sum);
                    continue;
                }
                
                data.miner = miner;
                i++;
                html+=renderCells(i,data);
            }

            $('#scoresheet_rows').html(html);
            $('#currentScores').hide();
            $('#scoresheetCard').show();
        }
    });
}

updateScoresheet();
</script>